{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold">Device Manager</h2>
        <p class="text-muted mb-0"><small id="last-updated">Last updated: Just now</small></p>
    </div>
    <div class="d-flex">
        <button id="refresh-devices" class="btn btn-outline-secondary me-2 d-flex align-items-center">
            <svg width="16" height="16" class="me-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
            <span>Refresh</span>
        </button>
        <button class="btn btn-primary d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#addDeviceModal">
            <svg width="20" height="20" class="me-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
            <span>Add Device</span>
        </button>
    </div>
</div>

{% if error %}
<div class="alert alert-danger" role="alert">
    <strong>Error:</strong> {{ error }}
</div>
{% endif %}

<div class="row g-4">
    {% if devices %}
        {% for device in devices %}
        <div class="col-md-6 col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h5 class="card-title fw-bold mb-1">{{ device.name }}</h5>
                            <p class="card-subtitle text-muted">{{ device.host }}:{{ device.port }}</p>
                        </div>
                        <div class="d-flex flex-column align-items-end">
                            <span class="badge mb-2
                                {% if device.status == 'online' %} bg-success 
                                {% elif device.status == 'offline' %} bg-danger
                                {% else %} bg-warning text-dark {% endif %}">
                                {{ device.status | capitalize if device.status else 'Unknown' }}
                            </span>
                            <button class="btn btn-sm toggle-status mb-2" 
                                    data-device-name="{{ device.name }}" 
                                    data-current-status="{{ device.status }}" 
                                    title="Toggle status">
                                {% if device.status == 'online' %}
                                    <span class="text-danger">Set Offline</span>
                                {% else %}
                                    <span class="text-success">Set Online</span>
                                {% endif %}
                            </button>
                        </div>
                    </div>
                    <div class="border-top pt-3">
                        <p class="mb-1"><strong class="fw-semibold">Type:</strong> {{ device.device_type }}</p>
                        <p class="mb-0"><strong class="fw-semibold">Platform:</strong> {{ device.platform }}</p>
                        <button class="btn btn-danger btn-sm delete-btn mt-2" data-device-name="{{ device.name }}">Delete</button>
                    </div>
                </div>
                <div class="card-footer bg-white border-top-0 d-flex justify-content-end">
                    <button class="btn btn-sm btn-outline-secondary me-2">Settings</button>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="col-12">
            <div class="card text-center py-5">
                <div class="card-body">
                    <h5 class="card-title">No Devices Found</h5>
                    <p class="card-text text-muted">There are no devices configured in the system yet.</p>
                </div>
            </div>
        </div>
    {% endif %}
</div>
<!-- Add Device Modal -->
<div class="modal fade" id="addDeviceModal" tabindex="-1" aria-labelledby="addDeviceModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addDeviceModalLabel">Add Device</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addDeviceForm">
          <div class="mb-3">
            <label for="deviceName" class="form-label">Name</label>
            <input type="text" class="form-control" id="deviceName" required>
          </div>
          <div class="mb-3">
            <label for="deviceHost" class="form-label">Host</label>
            <input type="text" class="form-control" id="deviceHost" value="172.16.39.102" required>
          </div>
          <div class="mb-3">
            <label for="devicePort" class="form-label">Port</label>
            <input type="number" class="form-control" id="devicePort" required>
          </div>
        </form>
        <div id="addDeviceError" class="alert alert-danger d-none" role="alert"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="addDeviceForm" class="btn btn-primary">Add Device</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.getElementById('addDeviceForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('deviceName').value.trim();
    const host = document.getElementById('deviceHost').value.trim();
    const port = document.getElementById('devicePort').value.trim();

    const errorEl = document.getElementById('addDeviceError');
    errorEl.classList.add('d-none');

    try {
      const resp = await fetch('/add_device', {  // Flask helper route
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, host, port })
      });
      if (!resp.ok) {
        const data = await resp.json();
        throw new Error(data.error || 'Failed to add device');
      }
      location.reload();
    } catch (err) {
      errorEl.textContent = err.message;
      errorEl.classList.remove('d-none');
    }
  });
</script>
{% endblock %}

{% block scripts %}
<script>
// Function to format date/time for last updated display
function formatDateTime(date) {
    const now = new Date();
    const diff = Math.floor((now - date) / 1000); // seconds difference
    
    if (diff < 5) return 'Just now';
    if (diff < 60) return `${diff} seconds ago`;
    if (diff < 3600) return `${Math.floor(diff / 60)} minutes ago`;
    if (diff < 86400) return `${Math.floor(diff / 3600)} hours ago`;
    
    // For older times, show the actual date/time
    return date.toLocaleString();
}

// Function to update last updated time display
function updateLastUpdatedTime() {
    const lastUpdatedEl = document.getElementById('last-updated');
    if (lastUpdatedEl) {
        lastUpdatedEl.textContent = `Last updated: ${formatDateTime(new Date())}`;
    }
}

// Function to update the device status display
function updateDeviceStatus(deviceName, newStatus) {
    // Try multiple approaches to find and update the status element
    try {
        // Approach 1: Find by device card and update badge
        const deviceCards = document.querySelectorAll('.card');
        for (const card of deviceCards) {
            if (card.textContent.includes(deviceName)) {
                const badge = card.querySelector('.badge');
                if (badge) {
                    // Update badge color
                    badge.className = 'badge';
                    if (newStatus === 'online') {
                        badge.classList.add('bg-success');
                    } else if (newStatus === 'offline') {
                        badge.classList.add('bg-danger');
                    } else {
                        badge.classList.add('bg-warning', 'text-dark');
                    }
                    
                    // Update text
                    badge.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
                    return true;
                }
            }
        }
    } catch (e) {
        console.error('Error in approach 1:', e);
    }
    
    // Approach 2: Find by data attribute if available
    try {
        const statusElement = document.querySelector(`[data-device-name="${deviceName}"] .badge, [data-device-name="${deviceName}"] .status`);
        if (statusElement) {
            statusElement.className = 'badge';
            if (newStatus === 'online') {
                statusElement.classList.add('bg-success');
            } else if (newStatus === 'offline') {
                statusElement.classList.add('bg-danger');
            } else {
                statusElement.classList.add('bg-warning', 'text-dark');
            }
            
            statusElement.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
            return true;
        }
    } catch (e) {
        console.error('Error in approach 2:', e);
    }
    
    return false; // Status element not found
}

// Function to fetch device statuses
async function fetchDeviceStatuses() {
    try {
        const response = await fetch('/api/devices');
        if (!response.ok) {
            throw new Error('Failed to fetch device statuses');
        }
        
        const devices = await response.json();
        let updatedCount = 0;
        
        devices.forEach(device => {
            if (updateDeviceStatus(device.name, device.status)) {
                updatedCount++;
            }
        });
        
        // Update the last updated timestamp
        const lastUpdated = document.getElementById('last-updated');
        if (lastUpdated) {
            lastUpdated.textContent = `Last updated: ${formatDateTime(new Date())}`;
        }
        
        return updatedCount;
    } catch (error) {
        console.error('Error fetching device statuses:', error);
        return 0;
    }
}

// Function to manually update a device's status
async function updateStatus(deviceName, newStatus) {
    try {
        const response = await fetch(`/api/device/${deviceName}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: newStatus })
        });
        
        if (!response.ok) {
            const data = await response.json();
            throw new Error(data.error || 'Failed to update status');
        }
        
        // Update the UI
        updateDeviceStatus(deviceName, newStatus);
        return true;
    } catch (error) {
        console.error('Error updating device status:', error);
        return false;
    }
}

// Set up auto-refresh and event handlers
document.addEventListener('DOMContentLoaded', () => {
    // Set up toggle status buttons
    const toggleButtons = document.querySelectorAll('.toggle-status');
    toggleButtons.forEach(button => {
        button.addEventListener('click', function() {
            const deviceName = this.getAttribute('data-device-name');
            const currentStatus = this.getAttribute('data-current-status');
            const newStatus = currentStatus === 'online' ? 'offline' : 'online';
            
            // Show loading state
            const originalText = this.innerHTML;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Updating...';
            this.disabled = true;
            
            // Try to update status
            fetch(`/api/device/${deviceName}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: newStatus })
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Status update failed');
                }
            })
            .then(data => {
                // Update UI
                updateDeviceStatus(deviceName, newStatus);
                
                // Reset button state with new text
                this.innerHTML = newStatus === 'online' ? 
                    '<span class="text-danger">Set Offline</span>' : 
                    '<span class="text-success">Set Online</span>';
                this.disabled = false;
                this.setAttribute('data-current-status', newStatus);
                
                // Update last updated time
                updateLastUpdatedTime();
            })
            .catch(error => {
                console.error('Error:', error);
                // Reset button to original state
                this.innerHTML = originalText;
                this.disabled = false;
                alert('Error updating device status');
            });
        });
    });
    
    // Set up refresh button
    const refreshDevicesBtn = document.getElementById('refresh-devices');
    if (refreshDevicesBtn) {
        refreshDevicesBtn.addEventListener('click', function() {
            // Show loading state
            this.classList.add('refreshing');
            this.disabled = true;
            
            // Fetch updated device statuses
            fetch('/api/devices')
            .then(response => response.json())
            .then(devices => {
                // Update each device's status in the UI
                devices.forEach(device => {
                    updateDeviceStatus(device.name, device.status);
                });
                
                // Update last updated time
                updateLastUpdatedTime();
                
                // Reset button state
                this.classList.remove('refreshing');
                this.disabled = false;
            })
            .catch(error => {
                console.error('Error refreshing device statuses:', error);
                this.classList.remove('refreshing');
                this.disabled = false;
                alert('Error refreshing device statuses');
            });
        });
    }
    
    // Set up delete buttons
    const deleteButtons = document.querySelectorAll('.delete-btn');
    deleteButtons.forEach(button => {
        button.addEventListener('click', (event) => {
            const deviceName = event.target.dataset.deviceName;
            if (confirm(`Are you sure you want to delete device '${deviceName}'? This action cannot be undone.`)) {
                fetch(`/device/delete/${deviceName}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || 'Server error'); });
                    }
                    return response.json();
                })
                .then(data => {
                    alert(data.message);
                    window.location.reload();
                })
                .catch(error => {
                    console.error('Deletion failed:', error);
                    alert(`Failed to delete device: ${error.message}`);
                });
            }
        });
    });
    
    // Set up manual refresh button
    const manualRefreshBtn = document.getElementById('refresh-devices');
    if (manualRefreshBtn) {
        manualRefreshBtn.addEventListener('click', async () => {
            manualRefreshBtn.disabled = true;
            try {
                const spinner = document.createElement('span');
                spinner.className = 'spinner-border spinner-border-sm ms-1';
                spinner.setAttribute('role', 'status');
                spinner.setAttribute('aria-hidden', 'true');
                manualRefreshBtn.appendChild(spinner);
                const originalText = manualRefreshBtn.innerHTML;
                
                await fetchDeviceStatuses();
                
                // Remove spinner and restore button
                manualRefreshBtn.innerHTML = originalText;
                manualRefreshBtn.disabled = false;
                manualRefreshBtn.classList.add('btn-success');
                
                // Reset after a short delay
                setTimeout(() => {
                    manualRefreshBtn.classList.remove('btn-success');
                    manualRefreshBtn.classList.add('btn-outline-secondary');
                    // No need to remove spinner as we replaced the entire innerHTML
                }, 1000);
            } catch (error) {
                console.error('Error during refresh:', error);
                manualRefreshBtn.disabled = false;
            }
        });
    }
    
    // Set up status toggle buttons if they exist
    document.querySelectorAll('.toggle-status').forEach(button => {
        button.addEventListener('click', async (event) => {
            const deviceName = event.target.dataset.deviceName;
            const currentStatus = event.target.dataset.currentStatus;
            const newStatus = currentStatus === 'online' ? 'offline' : 'online';
            
            button.disabled = true;
            const success = await updateStatus(deviceName, newStatus);
            
            if (success) {
                // Update the button's data attribute
                event.target.dataset.currentStatus = newStatus;
            }
            
            button.disabled = false;
        });
    });
    
    // Initial status fetch
    fetchDeviceStatuses();
    
    // Set up auto-refresh every 30 seconds
    setInterval(fetchDeviceStatuses, 30000);
});
</script>
{% endblock %}
